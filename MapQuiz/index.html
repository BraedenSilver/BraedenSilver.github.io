<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Quiz Drag & Drop</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; display: flex; flex-direction: column; }
        #header {
            background: #333; color: white; padding: 10px; display: flex; align-items: center; justify-content: space-between;
        }
        #controls { display: flex; gap: 10px; }
        #container { display: flex; flex: 1; height: calc(100% - 60px); }
        #sidebar {
            width: 250px; background: #f4f4f4; padding: 10px; overflow-y: auto; border-right: 2px solid #ccc;
            display: flex; flex-direction: column; gap: 10px;
        }
        #map { flex: 1; }
        
        .draggable-item {
            background: white; border: 1px solid #999; padding: 8px; cursor: grab;
            border-radius: 4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            user-select: none;
        }
        .draggable-item:active { cursor: grabbing; background: #e0e0e0; }
        .draggable-item.placed {
            background: #dff0d8; color: #3c763d; border-color: #d6e9c6; opacity: 0.6; cursor: default;
        }
        
        button {
            padding: 8px 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button.active { background: #004494; border: 2px solid white; }

        /* Specific styles for feedback */
        .feedback-popup { text-align: center; }
        .success { color: green; font-weight: bold; }
        .fail { color: red; }
    </style>
</head>
<body>

<div id="header">
    <div style="font-size: 20px; font-weight: bold;">Map Quiz Study Tool</div>
    <div id="timer-display" style="font-size: 24px; font-family: monospace; font-weight: bold; background: #222; padding: 5px 15px; border-radius: 4px; color: #0f0; margin: 0 20px;">00:00</div>
    <div id="controls">
        <select id="interaction-mode" onchange="setInteractionMode(this.value)" style="margin-right: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="drag">Drag & Drop Mode</option>
            <option value="typing">Typing Mode</option>
        </select>
        <button onclick="loadMode('RiversAndWaterways')" id="btn-rivers">Rivers & Waterways</button>
        <button onclick="loadMode('Regions')" id="btn-regions">Regions</button>
        <button onclick="loadMode('Cities')" id="btn-cities">Cities</button>
        <button onclick="showAnswers()" style="background: #ffc107; color: #333;">Show Answers</button>
        <button onclick="resetCurrentMode()" style="background: #dc3545;">Reset</button>
    </div>
</div>

<div id="container">
    <div id="sidebar">
        <div id="sidebar-instruction" style="font-weight: bold; margin-bottom: 5px;">Drag Items onto Map:</div>
        <div id="items-list">
            <!-- Draggable items will go here -->
        </div>
    </div>
    <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Embedded Data - No server needed
    const DATA = {
        "Rivers": [
            {"name": "Tigris River", "lat": 34.0, "lng": 44.0},
            {"name": "Euphrates River", "lat": 33.0, "lng": 43.0},
            {"name": "Nile River", "lat": 28.0, "lng": 30.8},
            {"name": "Danube River", "lat": 45.0, "lng": 19.0},
            {"name": "Rhine River", "lat": 50.0, "lng": 7.5}
        ],
        "Waterways": [
            {"name": "Aegean Sea", "lat": 38.0, "lng": 25.0},
            {"name": "Ionian Sea", "lat": 38.0, "lng": 19.0},
            {"name": "Mediterranean Sea", "lat": 35.0, "lng": 18.0},
            {"name": "Black Sea", "lat": 43.0, "lng": 34.0},
            {"name": "Baltic Sea", "lat": 56.0, "lng": 19.0},
            {"name": "Strait of Gibraltar", "lat": 35.9, "lng": -5.5},
            {"name": "Adriatic Sea", "lat": 43.0, "lng": 15.0},
            {"name": "Red Sea", "lat": 22.0, "lng": 38.0},
            {"name": "Persian Gulf", "lat": 27.0, "lng": 51.0}
        ],
        "Regions": [
            {"name": "Mesopotamia", "lat": 34.0, "lng": 43.5},
            {"name": "Sumer", "lat": 31.5, "lng": 46.0},
            {"name": "Assyrian Empire", "lat": 36.0, "lng": 43.0},
            {"name": "Carthage (Region)", "lat": 36.8, "lng": 10.3},
            {"name": "Gaul", "lat": 47.0, "lng": 2.0},
            {"name": "Britannia", "lat": 52.5, "lng": -1.5},
            {"name": "Iberian Peninsula", "lat": 40.0, "lng": -4.0},
            {"name": "Levant", "lat": 33.0, "lng": 36.0},
            {"name": "Asia Minor / Anatolia", "lat": 39.0, "lng": 34.0},
            {"name": "Balkans", "lat": 42.5, "lng": 23.0}
        ],
        "Cities": [
            {"name": "Ur", "lat": 30.96, "lng": 46.10},
            {"name": "Babylon", "lat": 32.53, "lng": 44.42},
            {"name": "Jerusalem", "lat": 31.76, "lng": 35.21},
            {"name": "Memphis", "lat": 29.85, "lng": 31.25},
            {"name": "Thebes", "lat": 25.72, "lng": 32.65},
            {"name": "Knossos", "lat": 35.30, "lng": 25.16},
            {"name": "Troy", "lat": 39.96, "lng": 26.24},
            {"name": "Athens", "lat": 37.98, "lng": 23.72},
            {"name": "Sparta", "lat": 37.08, "lng": 22.43},
            {"name": "Corinth", "lat": 37.91, "lng": 22.88},
            {"name": "Delphi", "lat": 38.48, "lng": 22.50},
            {"name": "Rome", "lat": 41.90, "lng": 12.49},
            {"name": "Pompeii", "lat": 40.75, "lng": 14.49},
            {"name": "Constantinople", "lat": 41.00, "lng": 28.98},
            {"name": "Aachen", "lat": 50.78, "lng": 6.08},
            {"name": "Hastings", "lat": 50.85, "lng": 0.57},
            {"name": "Paris", "lat": 48.85, "lng": 2.35},
            {"name": "London", "lat": 51.50, "lng": -0.12},
            {"name": "CÃ³rdoba", "lat": 37.88, "lng": -4.78},
            {"name": "Granada", "lat": 37.18, "lng": -3.60},
            {"name": "Venice", "lat": 45.44, "lng": 12.31},
            {"name": "Florence", "lat": 43.76, "lng": 11.25},
            {"name": "Genoa", "lat": 44.40, "lng": 8.94},
            {"name": "Vienna", "lat": 48.20, "lng": 16.37},
            {"name": "Wittenberg", "lat": 51.87, "lng": 12.65},
            {"name": "Worms", "lat": 49.63, "lng": 8.36}
        ]
    };

    // Initialize Map
    // Start centered roughly on Mediterranean
    var map = L.map('map').setView([38.0, 18.0], 5);

    // Using CartoDB Positron No Labels (perfect for quizzes)
    var tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    var currentItems = []; // Stores the data for current mode
    var markers = []; // Stores placed markers
    var targetMarkers = []; // Stores the hint dots
    var currentCategory = 'RiversAndWaterways'; // Track active category
    var interactionMode = 'drag'; // 'drag' or 'typing'
    
    // Timer Variables
    var timerInterval;
    var startTime;
    var timerRunning = false;

    // Fisher-Yates Shuffle
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function renderSidebar(data) {
        // ... (this function is further down, we will add timer logic before it)
    } // Just a placeholder for my mental map, I am adding functions below this block

    function startTimer() {
        if (timerRunning) return;
        timerRunning = true;
        startTime = Date.now();
        timerInterval = setInterval(updateTimerDisplay, 100);
    }

    function stopTimer() {
        if (!timerRunning) return;
        clearInterval(timerInterval);
        timerRunning = false;
    }
    
    function resetTimer() {
        stopTimer();
        const el = document.getElementById('timer-display');
        if(el) el.innerText = "00:00";
    }

    function updateTimerDisplay() {
        const now = Date.now();
        const diff = now - startTime;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        const str = (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
        const el = document.getElementById('timer-display');
        if(el) el.innerText = str;
    }

    function setInteractionMode(mode) {
        interactionMode = mode;
        loadMode(currentCategory);
    }

    function loadMode(mode) {
        resetTimer();
        currentCategory = mode;
        
        // Update Buttons
        document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
        var btn = document.getElementById('btn-' + (mode === 'RiversAndWaterways' ? 'rivers' : mode.toLowerCase()));
        if(btn) btn.classList.add('active');

        // Clear Sidebar
        const list = document.getElementById('items-list');
        list.innerHTML = '';
        
        // Clear Map Markers (Placed items)
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        // Clear Target Markers (Hint dots)
        targetMarkers.forEach(m => map.removeLayer(m));
        targetMarkers = [];
        
        // Prepare Data
        var data_to_render = [];
        if (mode === "RiversAndWaterways") {
            data_to_render = DATA["Rivers"].concat(DATA["Waterways"]);
        } else if (mode === "Regions") {
            data_to_render = DATA["Regions"]; // Note: this is a reference
            // Create a copy to avoid modifying the original DATA if we were shuffling in place
            data_to_render = [...DATA["Regions"]];
        } else if (mode === "Cities") {
            data_to_render = [...DATA["Cities"]];
        }

        currentItems = data_to_render;
        
        // Shuffle the list for the sidebar so it's not in the same order every time
        var shuffledList = shuffleArray([...data_to_render]);
        
        renderSidebar(shuffledList);
        renderTargetMarkers(data_to_render);
    }

    function renderTargetMarkers(data) {
        data.forEach(item => {
            // Create a gray dot for each location
            var circle = L.circleMarker([item.lat, item.lng], {
                radius: 8,
                color: '#666',
                weight: 1,
                fillColor: '#999',
                fillOpacity: 0.5
            }).addTo(map);
            
            // Tag it so we can remove it when matched
            circle.quizItemName = item.name;
            targetMarkers.push(circle);

            if (interactionMode === 'typing') {
                // Interactive click for typing mode
                circle.setStyle({ cursor: 'pointer', color: '#007bff', weight: 2 });
                circle.on('click', function(e) {
                     var container = document.createElement('div');
                     
                     var label = document.createElement('div');
                     label.innerText = 'Enter location name:';
                     label.style.marginBottom = '5px';
                     container.appendChild(label);

                     var input = document.createElement('input');
                     input.type = 'text';
                     input.style.width = '150px';
                     input.style.padding = '4px';
                     container.appendChild(input);
                     
                     var btn = document.createElement('button');
                     btn.innerText = 'Check';
                     btn.style.marginTop = '5px';
                     btn.style.width = '100%';
                     container.appendChild(btn);

                     function submit() {
                        checkTypingAnswer(input.value, item);
                     }

                     btn.onclick = submit;
                     input.onkeypress = function(ev) {
                        if (ev.key === 'Enter') submit();
                     };

                     L.popup()
                        .setLatLng(e.latlng)
                        .setContent(container)
                        .openOn(map);
                    
                     setTimeout(() => input.focus(), 100);
                });
            }
        });
    }

    function checkTypingAnswer(startValue, item) {
        if (!startValue) return;
        // Simple case-insensitive exact match
        if (startValue.trim().toLowerCase() === item.name.toLowerCase()) {
            map.closePopup();
            placeMarker(item, true);
            markItemStartAsPlaced(item);
        } else {
            alert('Incorrect. Check the Word Bank for the exact spelling.');
        }
    }

    function renderSidebar(data) {
        const list = document.getElementById('items-list');
        list.innerHTML = '';

        const instruction = document.getElementById('sidebar-instruction');
        if (instruction) {
             instruction.innerText = (interactionMode === 'typing') ? "Word Bank:" : "Drag Items onto Map:";
        }
        
        data.forEach(item => {
            let div = document.createElement('div');
            div.className = 'draggable-item';
            div.innerText = item.name;
            div.id = 'item-' + item.name.replace(/[^a-zA-Z0-9]/g, '');
            
            if (interactionMode === 'drag') {
                div.draggable = true;
                
                // Drag Events
                div.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify(item));
                    e.dataTransfer.effectAllowed = 'move';
                    div.style.opacity = '0.5';
                });
                
                div.addEventListener('dragend', (e) => {
                    div.style.opacity = '1';
                });
            } else {
                // Typing mode - just a list
                div.draggable = false;
                div.style.cursor = 'text';
                div.style.userSelect = 'text';
                div.style.color = '#333';
            }
            
            list.appendChild(div);
        });
    }

    function showAnswers() {
        if (!currentItems || currentItems.length === 0) return;
        
        if (confirm("Are you sure you want to reveal all answers? (This will stop the timer)")) {
            stopTimer();
            currentItems.forEach(item => {
                // Check if already placed (by checking sidebar state) to avoid duplicates
                const id = 'item-' + item.name.replace(/[^a-zA-Z0-9]/g, '');
                const el = document.getElementById(id);
                
                if (el && !el.classList.contains('placed')) {
                    placeMarker(item, true);
                    markItemStartAsPlaced(item);
                }
            });
        }
    }

    function resetCurrentMode() {
        // Reload current data to reset "placed" status
        const activeBtn = document.querySelector('#controls button.active');
        if (activeBtn) activeBtn.click();
    }

    // Map Drop Logic
    // Leaflet does not have native drop event for HTML elements, so we add it to the container
    const mapContainer = document.getElementById('map');

    mapContainer.addEventListener('dragover', (e) => {
        e.preventDefault(); // Necessary to allow dropping
        e.dataTransfer.dropEffect = 'move';
    });

    mapContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        const dataStr = e.dataTransfer.getData('text/plain');
        if (!dataStr) return;
        
        const item = JSON.parse(dataStr);
        
        // Calculate LatLng from mouse position
        // We need the map container offset
        const rect = mapContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const point = L.point(x, y);
        const latLng = map.containerPointToLatLng(point);
        
        checkPlacement(item, latLng);
    });

    function checkPlacement(item, dropLatLng) {
        const targetLatLng = L.latLng(item.lat, item.lng);
        const distance = dropLatLng.distanceTo(targetLatLng); // Meters
        
        // Threshold: 300km tolerance?
        const threshold = 300000; 
        
        if (distance < threshold) {
            // Correct - Snap to exact location for clarity
            placeMarker(item, true);
            markItemStartAsPlaced(item);
        } else {
            // Incorrect
            L.popup()
                .setLatLng(dropLatLng)
                .setContent('<span style="color:red; font-weight:bold;">Try again!</span>')
                .openOn(map);
        }
    }

    function placeMarker(item, success) {
        // Start timer on first placement if not running
        if (markers.length === 0 && !timerRunning) {
            startTimer();
        }

        // Remove the target circle for this item to avoid clutter
        var targetToRemove = targetMarkers.find(m => m.quizItemName === item.name);
        if(targetToRemove) {
            map.removeLayer(targetToRemove);
        }

        var marker = L.marker([item.lat, item.lng]).addTo(map);
        // Use a permanent tooltip instead of a popup so the name corresponds to the location always
        marker.bindTooltip(item.name, {
            permanent: true, 
            direction: 'auto',
            offset: [0, -10],
            opacity: 0.9
        }).openTooltip();
        markers.push(marker);

        // Check for completion
        if (markers.length === currentItems.length) {
            stopTimer();
            const timeStr = document.getElementById('timer-display').innerText;
            // Short delay to allow UI to update
            setTimeout(() => {
                alert("ðŸŽ‰ Stage Completed! ðŸŽ‰\n\nYour Time: " + timeStr);
            }, 100);
        }
    }
    
    function markItemStartAsPlaced(item) {
        const id = 'item-' + item.name.replace(/[^a-zA-Z0-9]/g, '');
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('placed');
            el.draggable = false;
        }
    }

    // Start with default
    loadMode('RiversAndWaterways');

</script>

</body>
</html>
